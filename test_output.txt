Test Execution Report
====================
Command: pytest tests/tasks -v
Date: Mon Dec  8 15:43:32 CET 2025
Working Directory: /lustre/fast/fast/txiao/ym/rl_onoff

Output:
-------
============================= test session starts ==============================
platform linux -- Python 3.10.19, pytest-9.0.2, pluggy-1.6.0 -- /fast/txiao/conda_envs/rl_onoff_hf/bin/python3.10
cachedir: .pytest_cache
rootdir: /lustre/fast/fast/txiao/ym/rl_onoff
plugins: anyio-4.12.0, typeguard-4.4.4, cov-7.0.0
collecting ... collected 140 items

tests/tasks/chat_templates/test_base.py::TestBaseChatTemplate::test_init_default_name PASSED [  0%]
tests/tasks/chat_templates/test_base.py::TestBaseChatTemplate::test_init_custom_name PASSED [  1%]
tests/tasks/chat_templates/test_base.py::TestBaseChatTemplate::test_format_simple_with_system FAILED [  2%]
tests/tasks/chat_templates/test_base.py::TestBaseChatTemplate::test_format_simple_without_system FAILED [  2%]
tests/tasks/chat_templates/test_base.py::TestBaseChatTemplate::test_format_simple_with_assistant FAILED [  3%]
tests/tasks/chat_templates/test_base.py::TestBaseChatTemplate::test_format_simple_with_generation_prompt PASSED [  4%]
tests/tasks/chat_templates/test_base.py::TestBaseChatTemplate::test_format_simple_all_roles PASSED [  5%]
tests/tasks/chat_templates/test_base.py::TestBaseChatTemplate::test_repr PASSED [  5%]
tests/tasks/chat_templates/test_chatml.py::TestChatMLTemplate::test_init PASSED [  6%]
tests/tasks/chat_templates/test_chatml.py::TestChatMLTemplate::test_format_single_user_message PASSED [  7%]
tests/tasks/chat_templates/test_chatml.py::TestChatMLTemplate::test_format_system_and_user PASSED [  7%]
tests/tasks/chat_templates/test_chatml.py::TestChatMLTemplate::test_format_with_assistant PASSED [  8%]
tests/tasks/chat_templates/test_chatml.py::TestChatMLTemplate::test_format_multiple_turns PASSED [  9%]
tests/tasks/chat_templates/test_chatml.py::TestChatMLTemplate::test_format_with_generation_prompt PASSED [ 10%]
tests/tasks/chat_templates/test_chatml.py::TestChatMLTemplate::test_format_empty_messages PASSED [ 10%]
tests/tasks/chat_templates/test_chatml.py::TestChatMLTemplate::test_format_empty_messages_with_generation_prompt PASSED [ 11%]
tests/tasks/chat_templates/test_chatml.py::TestChatMLTemplate::test_format_missing_role PASSED [ 12%]
tests/tasks/chat_templates/test_chatml.py::TestChatMLTemplate::test_format_missing_content PASSED [ 12%]
tests/tasks/chat_templates/test_chatml.py::TestChatMLTemplate::test_format_newline_separation PASSED [ 13%]
tests/tasks/chat_templates/test_chatml.py::TestChatMLTemplate::test_format_simple PASSED [ 14%]
tests/tasks/chat_templates/test_llama.py::TestLlamaChatTemplate::test_init PASSED [ 15%]
tests/tasks/chat_templates/test_llama.py::TestLlamaChatTemplate::test_format_single_user_message PASSED [ 15%]
tests/tasks/chat_templates/test_llama.py::TestLlamaChatTemplate::test_format_system_and_user PASSED [ 16%]
tests/tasks/chat_templates/test_llama.py::TestLlamaChatTemplate::test_format_with_assistant PASSED [ 17%]
tests/tasks/chat_templates/test_llama.py::TestLlamaChatTemplate::test_format_multiple_turns PASSED [ 17%]
tests/tasks/chat_templates/test_llama.py::TestLlamaChatTemplate::test_format_with_generation_prompt PASSED [ 18%]
tests/tasks/chat_templates/test_llama.py::TestLlamaChatTemplate::test_format_with_generation_prompt_after_assistant FAILED [ 19%]
tests/tasks/chat_templates/test_llama.py::TestLlamaChatTemplate::test_format_system_not_first PASSED [ 20%]
tests/tasks/chat_templates/test_llama.py::TestLlamaChatTemplate::test_format_empty_messages PASSED [ 20%]
tests/tasks/chat_templates/test_llama.py::TestLlamaChatTemplate::test_format_empty_messages_with_generation_prompt PASSED [ 21%]
tests/tasks/chat_templates/test_llama.py::TestLlamaChatTemplate::test_format_missing_role PASSED [ 22%]
tests/tasks/chat_templates/test_llama.py::TestLlamaChatTemplate::test_format_missing_content PASSED [ 22%]
tests/tasks/chat_templates/test_llama.py::TestLlamaChatTemplate::test_format_simple PASSED [ 23%]
tests/tasks/chat_templates/test_openai.py::TestOpenAIChatTemplate::test_init PASSED [ 24%]
tests/tasks/chat_templates/test_openai.py::TestOpenAIChatTemplate::test_format_single_user_message PASSED [ 25%]
tests/tasks/chat_templates/test_openai.py::TestOpenAIChatTemplate::test_format_system_and_user PASSED [ 25%]
tests/tasks/chat_templates/test_openai.py::TestOpenAIChatTemplate::test_format_with_assistant PASSED [ 26%]
tests/tasks/chat_templates/test_openai.py::TestOpenAIChatTemplate::test_format_multiple_turns PASSED [ 27%]
tests/tasks/chat_templates/test_openai.py::TestOpenAIChatTemplate::test_format_with_generation_prompt PASSED [ 27%]
tests/tasks/chat_templates/test_openai.py::TestOpenAIChatTemplate::test_format_empty_messages PASSED [ 28%]
tests/tasks/chat_templates/test_openai.py::TestOpenAIChatTemplate::test_format_empty_messages_with_generation_prompt PASSED [ 29%]
tests/tasks/chat_templates/test_openai.py::TestOpenAIChatTemplate::test_format_missing_role PASSED [ 30%]
tests/tasks/chat_templates/test_openai.py::TestOpenAIChatTemplate::test_format_missing_content PASSED [ 30%]
tests/tasks/chat_templates/test_openai.py::TestOpenAIChatTemplate::test_format_simple PASSED [ 31%]
tests/tasks/chat_templates/test_openai.py::TestOpenAIChatTemplate::test_format_simple_with_generation_prompt PASSED [ 32%]
tests/tasks/chat_templates/test_simple.py::TestSimpleChatTemplate::test_init_default_separator PASSED [ 32%]
tests/tasks/chat_templates/test_simple.py::TestSimpleChatTemplate::test_init_custom_separator PASSED [ 33%]
tests/tasks/chat_templates/test_simple.py::TestSimpleChatTemplate::test_format_single_user_message PASSED [ 34%]
tests/tasks/chat_templates/test_simple.py::TestSimpleChatTemplate::test_format_system_and_user PASSED [ 35%]
tests/tasks/chat_templates/test_simple.py::TestSimpleChatTemplate::test_format_with_assistant PASSED [ 35%]
tests/tasks/chat_templates/test_simple.py::TestSimpleChatTemplate::test_format_multiple_turns PASSED [ 36%]
tests/tasks/chat_templates/test_simple.py::TestSimpleChatTemplate::test_format_with_generation_prompt PASSED [ 37%]
tests/tasks/chat_templates/test_simple.py::TestSimpleChatTemplate::test_format_empty_messages PASSED [ 37%]
tests/tasks/chat_templates/test_simple.py::TestSimpleChatTemplate::test_format_empty_messages_with_generation_prompt PASSED [ 38%]
tests/tasks/chat_templates/test_simple.py::TestSimpleChatTemplate::test_format_empty_content PASSED [ 39%]
tests/tasks/chat_templates/test_simple.py::TestSimpleChatTemplate::test_format_missing_content PASSED [ 40%]
tests/tasks/chat_templates/test_simple.py::TestSimpleChatTemplate::test_format_custom_separator PASSED [ 40%]
tests/tasks/chat_templates/test_simple.py::TestSimpleChatTemplate::test_format_custom_separator_with_generation_prompt PASSED [ 41%]
tests/tasks/chat_templates/test_simple.py::TestSimpleChatTemplate::test_format_simple PASSED [ 42%]
tests/tasks/chat_templates/test_simple.py::TestSimpleChatTemplate::test_format_simple_with_assistant PASSED [ 42%]
tests/tasks/chat_templates/test_simple.py::TestSimpleChatTemplate::test_format_simple_with_generation_prompt PASSED [ 43%]
tests/tasks/formats/test_base.py::TestBaseFormat::test_init_default_name PASSED [ 44%]
tests/tasks/formats/test_base.py::TestBaseFormat::test_init_custom_name PASSED [ 45%]
tests/tasks/formats/test_base.py::TestBaseFormat::test_get_system_prompt PASSED [ 45%]
tests/tasks/formats/test_base.py::TestBaseFormat::test_extract PASSED    [ 46%]
tests/tasks/formats/test_base.py::TestBaseFormat::test_repr PASSED       [ 47%]
tests/tasks/formats/test_boxed.py::TestBoxedFormat::test_init PASSED     [ 47%]
tests/tasks/formats/test_boxed.py::TestBoxedFormat::test_get_system_prompt PASSED [ 48%]
tests/tasks/formats/test_boxed.py::TestBoxedFormat::test_extract_with_boxed_answer PASSED [ 49%]
tests/tasks/formats/test_boxed.py::TestBoxedFormat::test_extract_with_answer_pattern PASSED [ 50%]
tests/tasks/formats/test_boxed.py::TestBoxedFormat::test_extract_no_answer PASSED [ 50%]
tests/tasks/formats/test_boxed.py::TestBoxedFormat::test_extract_empty_response PASSED [ 51%]
tests/tasks/formats/test_boxed.py::TestBoxedFormat::test_extract_multiple_boxed PASSED [ 52%]
tests/tasks/formats/test_structured.py::TestStructuredFormat::test_init PASSED [ 52%]
tests/tasks/formats/test_structured.py::TestStructuredFormat::test_get_system_prompt PASSED [ 53%]
tests/tasks/formats/test_structured.py::TestStructuredFormat::test_extract_with_proper_tags PASSED [ 54%]
tests/tasks/formats/test_structured.py::TestStructuredFormat::test_extract_with_redacted_reasoning_tag PASSED [ 55%]
tests/tasks/formats/test_structured.py::TestStructuredFormat::test_extract_missing_tags PASSED [ 55%]
tests/tasks/formats/test_structured.py::TestStructuredFormat::test_extract_only_answer_tag PASSED [ 56%]
tests/tasks/formats/test_structured.py::TestStructuredFormat::test_extract_only_reasoning_tag PASSED [ 57%]
tests/tasks/formats/test_structured.py::TestStructuredFormat::test_extract_case_insensitive PASSED [ 57%]
tests/tasks/formats/test_structured.py::TestStructuredFormat::test_extract_multiline_content PASSED [ 58%]
tests/tasks/rewards/test_base.py::TestBaseReward::test_init_default_name PASSED [ 59%]
tests/tasks/rewards/test_base.py::TestBaseReward::test_init_custom_name PASSED [ 60%]
tests/tasks/rewards/test_base.py::TestBaseReward::test_compute_single PASSED [ 60%]
tests/tasks/rewards/test_base.py::TestBaseReward::test_compute_multiple PASSED [ 61%]
tests/tasks/rewards/test_base.py::TestBaseReward::test_callable PASSED   [ 62%]
tests/tasks/rewards/test_base.py::TestBaseReward::test_repr PASSED       [ 62%]
tests/tasks/rewards/test_base.py::TestRewardRegistry::test_init PASSED   [ 63%]
tests/tasks/rewards/test_base.py::TestRewardRegistry::test_register_with_default_name PASSED [ 64%]
tests/tasks/rewards/test_base.py::TestRewardRegistry::test_register_with_custom_name PASSED [ 65%]
tests/tasks/rewards/test_base.py::TestRewardRegistry::test_get_existing_reward PASSED [ 65%]
tests/tasks/rewards/test_base.py::TestRewardRegistry::test_get_nonexistent_reward PASSED [ 66%]
tests/tasks/rewards/test_base.py::TestRewardRegistry::test_list_rewards PASSED [ 67%]
tests/tasks/rewards/test_base.py::TestRewardRegistry::test_compute_all PASSED [ 67%]
tests/tasks/rewards/test_base.py::TestRewardRegistry::test_compute_all_subset PASSED [ 68%]
tests/tasks/rewards/test_base.py::TestRewardRegistry::test_compute_all_with_error PASSED [ 69%]
tests/tasks/rewards/test_base.py::TestRewardRegistry::test_clear PASSED  [ 70%]
tests/tasks/rewards/test_builtin.py::TestExactMatchReward::test_init_default PASSED [ 70%]
tests/tasks/rewards/test_builtin.py::TestExactMatchReward::test_init_normalize_false PASSED [ 71%]
tests/tasks/rewards/test_builtin.py::TestExactMatchReward::test_compute_exact_match_single PASSED [ 72%]
tests/tasks/rewards/test_builtin.py::TestExactMatchReward::test_compute_no_match_single PASSED [ 72%]
tests/tasks/rewards/test_builtin.py::TestExactMatchReward::test_compute_exact_match_list PASSED [ 73%]
tests/tasks/rewards/test_builtin.py::TestExactMatchReward::test_compute_partial_match_list PASSED [ 74%]
tests/tasks/rewards/test_builtin.py::TestExactMatchReward::test_compute_normalize_true PASSED [ 75%]
tests/tasks/rewards/test_builtin.py::TestExactMatchReward::test_compute_normalize_false PASSED [ 75%]
tests/tasks/rewards/test_builtin.py::TestExactMatchReward::test_bleu_reward_available PASSED [ 76%]
tests/tasks/rewards/test_builtin.py::TestExactMatchReward::test_rouge_reward_available PASSED [ 77%]
tests/tasks/rewards/test_builtin.py::TestMathVerifyReward::test_init PASSED [ 77%]
tests/tasks/rewards/test_builtin.py::TestMathVerifyReward::test_compute_with_math_verify_available PASSED [ 78%]
tests/tasks/rewards/test_builtin.py::TestMathVerifyReward::test_compute_without_math_verify FAILED [ 79%]
tests/tasks/rewards/test_builtin.py::TestMathVerifyReward::test_extract_answer_from_text PASSED [ 80%]
tests/tasks/test_base.py::TestBaseTask::test_init_default_name PASSED    [ 80%]
tests/tasks/test_base.py::TestBaseTask::test_init_custom_name PASSED     [ 81%]
tests/tasks/test_base.py::TestBaseTask::test_init_with_format PASSED     [ 82%]
tests/tasks/test_base.py::TestBaseTask::test_get_system_prompt PASSED    [ 82%]
tests/tasks/test_base.py::TestBaseTask::test_answer_extractor PASSED     [ 83%]
tests/tasks/test_base.py::TestBaseTask::test_format_prompt_single PASSED [ 84%]
tests/tasks/test_base.py::TestBaseTask::test_format_prompt_with_kwargs PASSED [ 85%]
tests/tasks/test_base.py::TestBaseTask::test_format_prompts_single PASSED [ 85%]
tests/tasks/test_base.py::TestBaseTask::test_format_prompts_multiple PASSED [ 86%]
tests/tasks/test_base.py::TestBaseTask::test_format_query PASSED         [ 87%]
tests/tasks/test_base.py::TestBaseTask::test_evaluate PASSED             [ 87%]
tests/tasks/test_base.py::TestBaseTask::test_evaluate_list PASSED        [ 88%]
tests/tasks/test_base.py::TestBaseTask::test_repr PASSED                 [ 89%]
tests/tasks/test_math.py::TestMathTask::test_init_default PASSED         [ 90%]
tests/tasks/test_math.py::TestMathTask::test_init_custom_name PASSED     [ 90%]
tests/tasks/test_math.py::TestMathTask::test_init_custom_template PASSED [ 91%]
tests/tasks/test_math.py::TestMathTask::test_init_custom_format PASSED   [ 92%]
tests/tasks/test_math.py::TestMathTask::test_get_prompt_template_default PASSED [ 92%]
tests/tasks/test_math.py::TestMathTask::test_get_prompt_template_custom PASSED [ 93%]
tests/tasks/test_math.py::TestMathTask::test_get_system_prompt_default PASSED [ 94%]
tests/tasks/test_math.py::TestMathTask::test_get_system_prompt_structured PASSED [ 95%]
tests/tasks/test_math.py::TestMathTask::test_answer_extractor_boxed PASSED [ 95%]
tests/tasks/test_math.py::TestMathTask::test_answer_extractor_structured PASSED [ 96%]
tests/tasks/test_math.py::TestMathTask::test_format_prompt PASSED        [ 97%]
tests/tasks/test_math.py::TestMathTask::test_format_prompts_single PASSED [ 97%]
tests/tasks/test_math.py::TestMathTask::test_format_prompts_multiple PASSED [ 98%]
tests/tasks/test_math.py::TestMathTask::test_evaluate PASSED             [ 99%]
tests/tasks/test_math.py::TestMathTask::test_repr PASSED                 [100%]

=================================== FAILURES ===================================
_____________ TestBaseChatTemplate.test_format_simple_with_system ______________

self = <tests.tasks.chat_templates.test_base.TestBaseChatTemplate object at 0x14c00f3a6a70>

    def test_format_simple_with_system(self):
        """Test format_simple with system message."""
        template = ConcreteChatTemplate()
        result = template.format_simple(
            user_message="Hello",
            system_message="You are helpful"
        )
>       assert "system: You are helpful" in result.lower()
E       AssertionError: assert 'system: You are helpful' in 'system: you are helpful\nuser: hello'
E        +  where 'system: you are helpful\nuser: hello' = <built-in method lower of str object at 0x14c0e80eb5d0>()
E        +    where <built-in method lower of str object at 0x14c0e80eb5d0> = 'system: You are helpful\nuser: Hello'.lower

tests/tasks/chat_templates/test_base.py:39: AssertionError
____________ TestBaseChatTemplate.test_format_simple_without_system ____________

self = <tests.tasks.chat_templates.test_base.TestBaseChatTemplate object at 0x14c00f3a67a0>

    def test_format_simple_without_system(self):
        """Test format_simple without system message."""
        template = ConcreteChatTemplate()
        result = template.format_simple(user_message="Hello")
>       assert "user: Hello" in result.lower()
E       AssertionError: assert 'user: Hello' in 'user: hello'
E        +  where 'user: hello' = <built-in method lower of str object at 0x14c00f310e70>()
E        +    where <built-in method lower of str object at 0x14c00f310e70> = 'user: Hello'.lower

tests/tasks/chat_templates/test_base.py:46: AssertionError
____________ TestBaseChatTemplate.test_format_simple_with_assistant ____________

self = <tests.tasks.chat_templates.test_base.TestBaseChatTemplate object at 0x14c00f3a64d0>

    def test_format_simple_with_assistant(self):
        """Test format_simple with assistant message."""
        template = ConcreteChatTemplate()
        result = template.format_simple(
            user_message="Hello",
            assistant_message="Hi there"
        )
>       assert "user: Hello" in result.lower()
E       AssertionError: assert 'user: Hello' in 'user: hello\nassistant: hi there'
E        +  where 'user: hello\nassistant: hi there' = <built-in method lower of str object at 0x14c010442150>()
E        +    where <built-in method lower of str object at 0x14c010442150> = 'user: Hello\nassistant: Hi there'.lower

tests/tasks/chat_templates/test_base.py:56: AssertionError
___ TestLlamaChatTemplate.test_format_with_generation_prompt_after_assistant ___

self = <tests.tasks.chat_templates.test_llama.TestLlamaChatTemplate object at 0x14c00f3b2a10>

    def test_format_with_generation_prompt_after_assistant(self):
        """Test generation prompt not added after assistant message."""
        template = LlamaChatTemplate()
        messages = [
            {"role": "user", "content": "Hello"},
            {"role": "assistant", "content": "Hi"}
        ]
        result = template.format(messages, add_generation_prompt=True)
        assert "Hi </s>" in result
        # Should not add generation prompt after assistant
>       assert result.count("<s> [INST]") == 0
E       AssertionError: assert 1 == 0
E        +  where 1 = <built-in method count of str object at 0x14c0e80eb5d0>('<s> [INST]')
E        +    where <built-in method count of str object at 0x14c0e80eb5d0> = '<s> [INST] Hello [/INST] Hi </s>'.count

tests/tasks/chat_templates/test_llama.py:84: AssertionError
____________ TestMathVerifyReward.test_compute_without_math_verify _____________

self = <tests.tasks.rewards.test_builtin.TestMathVerifyReward object at 0x14c00f240d30>

    def test_compute_without_math_verify(self):
        """Test compute when math_verify is not available."""
        with patch('rl_onoff.tasks.rewards.builtin.MATH_VERIFY_AVAILABLE', False):
>           reward = MathVerifyReward()

tests/tasks/rewards/test_builtin.py:108: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = MathVerifyReward(name=math_verify)

    def __init__(self):
        """Initialize math verify reward."""
        super().__init__("math_verify")
        if not MATH_VERIFY_AVAILABLE:
>           raise ImportError(
                "math_verify is not installed. Install it with: pip install math-verify"
            )
E           ImportError: math_verify is not installed. Install it with: pip install math-verify

rl_onoff/tasks/rewards/builtin.py:293: ImportError
=========================== short test summary info ============================
FAILED tests/tasks/chat_templates/test_base.py::TestBaseChatTemplate::test_format_simple_with_system
FAILED tests/tasks/chat_templates/test_base.py::TestBaseChatTemplate::test_format_simple_without_system
FAILED tests/tasks/chat_templates/test_base.py::TestBaseChatTemplate::test_format_simple_with_assistant
FAILED tests/tasks/chat_templates/test_llama.py::TestLlamaChatTemplate::test_format_with_generation_prompt_after_assistant
FAILED tests/tasks/rewards/test_builtin.py::TestMathVerifyReward::test_compute_without_math_verify
======================== 5 failed, 135 passed in 11.62s ========================
